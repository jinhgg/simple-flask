# -*- coding: utf-8 -*-
from werkzeug.routing import Rule, Map
from werkzeug.wrappers import Response
from werkzeug.wrappers import Request
from werkzeug.exceptions import HTTPException
from werkzeug.local import LocalStack, LocalProxy


class _RequestContext(object):

    def __init__(self, app, environ):
        self.app = app
        self.url_adapter = app.url_map.bind_to_environ(
            environ)
        self.request = Request(environ)

    def __enter__(self):
        _request_ctx_stack.push(self)

    def __exit__(self, exc_type, exc_value, tb):
        _request_ctx_stack.pop()


class SimpleFlask(object):

    def __init__(self):
        self.debug = False
        self.url_map = Map()
        self.view_functions = {}
        self.error_handlers = {}

    def __call__(self, environ, start_response):
        return self.wsgi_app(environ, start_response)

    def add_url_rule(self, rule, endpoint, **options):

        options['endpoint'] = endpoint
        options.setdefault('methods', ('GET',))
        self.url_map.add(Rule(rule, **options))

    def route(self, rule, **options):
        def decorator(f):
            self.add_url_rule(rule, f.__name__, **options)
            self.view_functions[f.__name__] = f
            return f

        return decorator

    def run(self, host='localhost', port=5000, **options):
        from werkzeug.serving import run_simple

        if 'debug' in options:
            self.debug = options.pop('debug')
        # 如果debug为True，开启重载器（reloader）
        options.setdefault('use_reloader', self.debug)
        # 如果debug为True，开启调试器（debugger）
        options.setdefault('use_debugger', self.debug)
        return run_simple(host, port, self, **options)


    def match_request(self):
        rv = _request_ctx_stack.top.url_adapter.match()
        request.endpoint, request.view_args = rv
        return rv

    def dispatch_request(self):
        try:
            endpoint, values = self.match_request()
            return self.view_functions[endpoint](**values)
        except HTTPException, e:
            handler = self.error_handlers.get(e.code)
            if handler is None:
                return e
            return handler(e)
        except Exception, e:
            handler = self.error_handlers.get(500)
            if self.debug or handler is None:
                raise
            return handler(e)


    def wsgi_app(self, environ, start_response):

        with _RequestContext(self,environ):
            rv = self.dispatch_request()
            response = Response(rv)
            return response(environ, start_response)


_request_ctx_stack = LocalStack()
request = LocalProxy(lambda: _request_ctx_stack.top.request)

